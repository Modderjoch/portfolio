---
import { getCollection } from "astro:content";
import ProjectCard from "./ProjectCard.astro";
import ProjectPreview from "./ProjectPreview.astro";

const projects = await getCollection("projects");
projects.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<section class="relative w-screen overflow-hidden py-10">
    <div class="carousel-track flex items-center gap-8">
        {
            projects.map((project, index) => (
                <div class="carousel-item" data-index={index}>
                    <ProjectCard project={project} />
                </div>
            ))
        }
    </div>

    <button
        class="absolute left-2 top-1/2 -translate-y-1/2 z-20 prev-btn text-3xl"
        >‹</button
    >
    <button
        class="absolute right-2 top-1/2 -translate-y-1/2 z-20 next-btn text-3xl"
        >›</button
    >
</section>

<style>
    .carousel-track {
        transition: transform 0.5s ease;
        position: relative;
    }

    .carousel-item {
        flex: 0 0 20%; /* 5 items across full width */
        transition:
            transform 0.5s ease,
            filter 0.5s ease,
            opacity 0.5s ease;
    }
</style>

<script>
    const track = document.querySelector(".carousel-track");
    const items = Array.from(track.querySelectorAll(".carousel-item"));
    const total = items.length;
    let centerIndex = 0;

    // Create a virtual circular array for seamless looping
    function getVirtualIndex(i) {
        return ((i % total) + total) % total;
    }

    function updateCarousel() {
        items.forEach((item, i) => {
            const distance = Math.min(
                Math.abs(getVirtualIndex(i - centerIndex)),
                total - Math.abs(getVirtualIndex(i - centerIndex)),
            );

            if (distance === 0) {
                item.style.transform = "scale(1.1)";
                item.style.filter = "blur(0)";
                item.style.opacity = "1";
                item.style.zIndex = "3";
            } else if (distance === 1) {
                item.style.transform = "scale(1)";
                item.style.filter = "blur(0)";
                item.style.opacity = "1";
                item.style.zIndex = "2";
            } else if (distance === 2) {
                item.style.transform = "scale(0.85)";
                item.style.filter = "blur(4px)";
                item.style.opacity = "0.5";
                item.style.zIndex = "1";
            } else {
                item.style.transform = "scale(0.75)";
                item.style.filter = "blur(6px)";
                item.style.opacity = "0";
                item.style.zIndex = "0";
            }
        });

        // Center the middle item visually
        const centerItem = items[getVirtualIndex(centerIndex)];
        const offset =
            centerItem.offsetLeft +
            centerItem.offsetWidth / 2 -
            window.innerWidth / 2;
        track.style.transform = `translateX(${-offset}px)`;
    }

    document.querySelector(".prev-btn").addEventListener("click", () => {
        centerIndex = getVirtualIndex(centerIndex - 1);
        updateCarousel();
    });

    document.querySelector(".next-btn").addEventListener("click", () => {
        centerIndex = getVirtualIndex(centerIndex + 1);
        updateCarousel();
    });

    window.addEventListener("resize", updateCarousel);
    updateCarousel();
</script>
